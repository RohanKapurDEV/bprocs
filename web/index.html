<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV â†’ Lightweight-Charts Viewer</title>

    <!-- TradingView Lightweight-Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

    <style>
      :root {
        --bg: #0d1117;
        --panel: #161b22;
        --fg: #c9d1d9;
        --up: #26a69a;
        --down: #ef5350;
        --grid: #21262d;
        --border: #30363d;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, sans-serif;
      }
      body {
        background: var(--bg);
        color: var(--fg);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 1rem;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 1rem;
      }
      input[type="file"] {
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--border);
        padding: 0.5rem 0.75rem;
        cursor: pointer;
      }
      input[type="file"]::-webkit-file-upload-button {
        background: var(--panel);
        border: none;
        color: var(--fg);
        padding: 0.5rem 0.75rem;
        cursor: pointer;
      }
      #chart {
        flex: 1;
        width: 100%;
        position: relative;
      }

      /* Tooltip */
      .tooltip {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        background: rgba(22, 27, 34, 0.96);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        color: var(--fg);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.15s;
      }
      .tooltip.visible {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header>
      <label
        >Select OHLCV CSV
        <input id="fileInput" type="file" accept=".csv" />
      </label>
    </header>

    <div id="chart"></div>

    <script>
      const $ = (s) => document.querySelector(s);
      const css = (v) =>
        getComputedStyle(document.documentElement).getPropertyValue(v).trim();

      /* ---------- Chart ---------- */
      const chartDiv = $("#chart");
      const chart = LightweightCharts.createChart(chartDiv, {
        width: chartDiv.clientWidth,
        height: chartDiv.clientHeight,
        layout: { background: { color: css("--bg") }, textColor: css("--fg") },
        grid: {
          vertLines: { color: css("--grid") },
          horzLines: { color: css("--grid") },
        },
        rightPriceScale: { borderColor: css("--border") },
        timeScale: {
          borderColor: css("--border"),
          timeVisible: true, // show time for intraday bars
          secondsVisible: true, // include seconds
        },
      });
      window.addEventListener("resize", () =>
        chart.applyOptions({
          width: chartDiv.clientWidth,
          height: chartDiv.clientHeight,
        })
      );

      const candles = chart.addCandlestickSeries({
        upColor: css("--up"),
        borderUpColor: css("--up"),
        wickUpColor: css("--up"),
        downColor: css("--down"),
        borderDownColor: css("--down"),
        wickDownColor: css("--down"),
      });
      const volumes = chart.addHistogramSeries({
        priceFormat: { type: "volume" },
        priceScaleId: "vol",
        scaleMargins: { top: 0.8, bottom: 0 },
      });
      chart
        .priceScale("vol")
        .applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

      /* ---------- Tooltip ---------- */
      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      chartDiv.appendChild(tooltip);

      /* ---------- Data lookup ---------- */
      let barMap = new Map(),
        volMap = new Map();

      /* ---------- CSV loader ---------- */
      $("#fileInput").addEventListener("change", (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (e) => {
          const rows = e.target.result.trim().split(/\r?\n/).slice(1);
          const cData = [],
            vData = [];
          barMap.clear();
          volMap.clear();
          for (const line of rows) {
            const [ts, o, h, l, c, v] = line.split(",").map((s) => s.trim());
            const time = Math.floor(new Date(ts).getTime() / 1000); // epoch seconds
            const open = +o,
              high = +h,
              low = +l,
              close = +c,
              vol = +v;

            const bar = { time, open, high, low, close };
            cData.push(bar);
            vData.push({
              time,
              value: vol,
              color: close >= open ? css("--up") : css("--down"),
            });
            barMap.set(time, bar);
            volMap.set(time, vol);
          }
          cData.sort((a, b) => a.time - b.time);
          vData.sort((a, b) => a.time - b.time);
          candles.setData(cData);
          volumes.setData(vData);
          chart.timeScale().fitContent();
        };
        r.readAsText(f);
      });

      /* ---------- Crosshair / Tooltip ---------- */
      chart.subscribeCrosshairMove((p) => {
        if (!p.time || !p.point) {
          tooltip.classList.remove("visible");
          return;
        }

        const bar = barMap.get(p.time);
        if (!bar) {
          tooltip.classList.remove("visible");
          return;
        }
        const vol = volMap.get(p.time) ?? 0;
        const ts = new Date(p.time * 1000)
          .toISOString()
          .replace("T", " ")
          .substring(0, 19); // YYYY-MM-DD HH:MM:SS

        tooltip.innerHTML = `<strong>${ts}</strong><br>
		O: ${bar.open}&nbsp; H: ${bar.high}&nbsp; L: ${bar.low}&nbsp; C: ${bar.close}<br>
		V: ${vol}`;

        const m = 12;
        let left = p.point.x + m,
          top = p.point.y + m;
        if (left + tooltip.clientWidth > chartDiv.clientWidth)
          left = p.point.x - m - tooltip.clientWidth;
        if (top + tooltip.clientHeight > chartDiv.clientHeight)
          top = p.point.y - m - tooltip.clientHeight;
        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.classList.add("visible");
      });
    </script>
  </body>
</html>
